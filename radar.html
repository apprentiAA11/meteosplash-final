<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Radar M√©t√©o ‚Äì Test Option B</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        sans-serif;
      background: #020617;
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    .app {
      max-width: 960px;
      margin: 16px auto;
      padding: 16px;
      background: radial-gradient(circle at top, #0f172a, #020617);
      border-radius: 18px;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.25);
    }
    h1 {
      margin: 0 0 4px;
      font-size: 1.4rem;
    }
    .subtitle {
      margin: 0 0 12px;
      font-size: 0.85rem;
      color: #9ca3af;
    }

    .top-row {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .coords-input {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .coords-input input {
      width: 110px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.8rem;
    }
    .coords-input input:focus {
      outline: none;
      border-color: #60a5fa;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.4);
    }
    .button {
      border-radius: 999px;
      border: none;
      padding: 6px 12px;
      font-size: 0.8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: #2563eb;
      color: #f9fafb;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.55);
    }
    .button.secondary {
      background: #111827;
      color: #e5e7eb;
      box-shadow: none;
    }

    #map {
      width: 100%;
      height: 360px;
      border-radius: 16px;
      overflow: hidden;
      margin-bottom: 10px;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(15, 23, 42, 0.8);
    }

    .timeline-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0 4px;
      flex-wrap: wrap;
    }
    .timeline-label {
      font-size: 0.8rem;
      color: #9ca3af;
      min-width: 120px;
    }
    .timeline-slider-wrap {
      flex: 1;
    }
    .timeline-slider-wrap input[type="range"] {
      width: 100%;
      -webkit-appearance: none;
      appearance: none;
      height: 4px;
      border-radius: 999px;
      background: linear-gradient(to right, #1f2937, #4b5563);
      outline: none;
    }
    .timeline-slider-wrap input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #f9fafb;
      border: 2px solid #2563eb;
      margin-top: -7px;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.6);
    }
    .timeline-slider-wrap input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #f9fafb;
      border: 2px solid #2563eb;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.6);
    }

    .timeline-buttons {
      display: flex;
      gap: 6px;
    }
    .chip {
      border-radius: 999px;
      border: none;
      padding: 4px 10px;
      font-size: 0.75rem;
      cursor: pointer;
      background: #111827;
      color: #e5e7eb;
    }
    .chip.active {
      background: #2563eb;
      color: #f9fafb;
    }

    .bottom-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      gap: 8px;
      flex-wrap: wrap;
    }
    .intensity {
      font-size: 0.8rem;
      color: #e5e7eb;
    }
    .legend {
      display: flex;
      gap: 10px;
      font-size: 0.75rem;
      color: #9ca3af;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display: inline-block;
    }
    .dot.low { background: #4a9dff; }
    .dot.med { background: #22c55e; }
    .dot.high { background: #facc15; }
    .dot.very { background: #f97316; }

    @media (max-width: 640px) {
      .timeline-label { min-width: 90px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>Radar M√©t√©o ‚Äì Mix OpenWeather / Open-Meteo</h1>
    <p class="subtitle">
      Carte = pluie r√©elle OpenWeather. Timeline = pr√©visions pluie Open-Meteo.
    </p>

    <div class="top-row">
      <div class="coords-input">
        <input id="lat-input" type="number" step="0.01" value="48.86" />
        <input id="lon-input" type="number" step="0.01" value="2.35" />
      </div>
      <button id="btn-load" class="button">Charger la m√©t√©o</button>
      <button id="btn-mypos" class="button secondary">üìç Ma position</button>
    </div>

    <div id="map"></div>

    <div class="timeline-row">
      <div class="timeline-label" id="time-label">Maintenant</div>
      <div class="timeline-slider-wrap">
        <input id="time-slider" type="range" min="0" max="54" value="18" />
      </div>
      <div class="timeline-buttons">
        <button id="btn-hist" class="chip active">Hist.</button>
        <button id="btn-now" class="chip">Now</button>
        <button id="btn-fut" class="chip">Futur</button>
        <button id="btn-play" class="chip">‚ñ∂Ô∏é</button>
      </div>
    </div>

    <div class="bottom-row">
      <div class="intensity" id="intensity-label">
        Pluie pr√©vue : ‚Äî mm/h
      </div>
      <div class="legend">
        <span class="legend-item">
          <span class="dot low"></span> faible
        </span>
        <span class="legend-item">
          <span class="dot med"></span> mod√©r√©e
        </span>
        <span class="legend-item">
          <span class="dot high"></span> forte
        </span>
        <span class="legend-item">
          <span class="dot very"></span> tr√®s forte
        </span>
      </div>
    </div>
  </div>

  <script>
    const OPENWEATHER_KEY = "c63f9893f5d21327a9c390818db9f240";

    let map;
    let owLayer = null;
    let precipSeries = []; // { time: Date, value: mm/h }
    let slider = document.getElementById("time-slider");
    let timeLabel = document.getElementById("time-label");
    let intensityLabel = document.getElementById("intensity-label");
    let btnHist = document.getElementById("btn-hist");
    let btnNow = document.getElementById("btn-now");
    let btnFut = document.getElementById("btn-fut");
    let btnPlay = document.getElementById("btn-play");
    let playing = false;
    let playTimer = null;

    function initMap() {
      map = L.map("map").setView([48.86, 2.35], 7);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18
      }).addTo(map);
    }

    function setOwLayer() {
      const url = `https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=${OPENWEATHER_KEY}`;
      if (owLayer) {
        map.removeLayer(owLayer);
      }
      owLayer = L.tileLayer(url, {
        opacity: 0.75
      });
      owLayer.addTo(map);
    }

    function fetchOpenMeteo(lat, lon) {
      const url =
        "https://api.open-meteo.com/v1/forecast?" +
        "latitude=" + encodeURIComponent(lat) +
        "&longitude=" + encodeURIComponent(lon) +
        "&hourly=precipitation" +
        "&forecast_hours=12";

      return fetch(url)
        .then((res) => res.json())
        .then((data) => {
          const times = data.hourly?.time || [];
          const values = data.hourly?.precipitation || [];
          const now = new Date();

          let arr = [];
          for (let i = 0; i < times.length; i++) {
            const t = new Date(times[i]);
            if (t >= now && arr.length < 10) {
              arr.push({ time: t, value: values[i] ?? 0 });
            }
          }

          precipSeries = [];
          if (!arr.length) return;

          const first = arr[0].time;
          const last = arr[arr.length - 1].time;
          const totalMinutes = (last - first) / (1000 * 60);
          const steps = 54;
          const stepMinutes = totalMinutes / steps;

          for (let k = 0; k <= steps; k++) {
            const tStep = new Date(first.getTime() + k * stepMinutes * 60 * 1000);
            let closest = arr[0];
            let bestDiff = Math.abs(arr[0].time - tStep);
            for (let j = 1; j < arr.length; j++) {
              const diff = Math.abs(arr[j].time - tStep);
              if (diff < bestDiff) {
                bestDiff = diff;
                closest = arr[j];
              }
            }
            precipSeries.push({
              time: tStep,
              value: closest.value
            });
          }

          slider.min = 0;
          slider.max = precipSeries.length - 1;
          slider.value = Math.floor(precipSeries.length / 3);
          updateFromSlider();
        });
    }

    function updateFromSlider() {
      const idx = Number(slider.value || 0);
      const frame = precipSeries[idx];
      if (!frame) {
        timeLabel.textContent = "Maintenant";
        intensityLabel.textContent = "Pluie pr√©vue : ‚Äî mm/h";
        return;
      }
      const h = frame.time.getHours().toString().padStart(2, "0");
      const m = frame.time.getMinutes().toString().padStart(2, "0");
      timeLabel.textContent = `Vers ${h}h${m}`;
      const v = frame.value;
      intensityLabel.textContent = `Pluie pr√©vue : ${v.toFixed(1)} mm/h`;
    }

    function setChipMode(mode) {
      btnHist.classList.remove("active");
      btnNow.classList.remove("active");
      btnFut.classList.remove("active");
      if (mode === "hist") btnHist.classList.add("active");
      if (mode === "now") btnNow.classList.add("active");
      if (mode === "fut") btnFut.classList.add("active");
    }

    function startPlay() {
      if (playing || !precipSeries.length) return;
      playing = true;
      btnPlay.textContent = "‚è∏";
      playTimer = setInterval(() => {
        let v = Number(slider.value || 0);
        const max = Number(slider.max || "0");
        v = v >= max ? 0 : v + 1;
        slider.value = String(v);
        updateFromSlider();
      }, 500);
    }

    function stopPlay() {
      playing = false;
      btnPlay.textContent = "‚ñ∂Ô∏é";
      if (playTimer) {
        clearInterval(playTimer);
        playTimer = null;
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      initMap();
      setOwLayer();

      document.getElementById("btn-load").addEventListener("click", () => {
        const lat = Number(document.getElementById("lat-input").value || "48.86");
        const lon = Number(document.getElementById("lon-input").value || "2.35");
        map.setView([lat, lon], 8);
        setOwLayer();
        fetchOpenMeteo(lat, lon);
      });

      document.getElementById("btn-mypos").addEventListener("click", () => {
        if (!navigator.geolocation) {
          alert("G√©olocalisation non disponible.");
          return;
        }
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            document.getElementById("lat-input").value = lat.toFixed(2);
            document.getElementById("lon-input").value = lon.toFixed(2);
            map.setView([lat, lon], 9);
            setOwLayer();
            fetchOpenMeteo(lat, lon);
          },
          () => alert("Impossible de r√©cup√©rer la position.")
        );
      });

      slider.addEventListener("input", () => {
        stopPlay();
        updateFromSlider();
      });

      btnHist.addEventListener("click", () => {
        if (!precipSeries.length) return;
        slider.value = 0;
        updateFromSlider();
        setChipMode("hist");
      });
      btnNow.addEventListener("click", () => {
        if (!precipSeries.length) return;
        slider.value = Math.floor(precipSeries.length / 3);
        updateFromSlider();
        setChipMode("now");
      });
      btnFut.addEventListener("click", () => {
        if (!precipSeries.length) return;
        slider.value = slider.max;
        updateFromSlider();
        setChipMode("fut");
      });

      btnPlay.addEventListener("click", () => {
        if (playing) stopPlay();
        else startPlay();
      });

      document.getElementById("btn-load").click();
    });
  </script>
</body>
</html>
